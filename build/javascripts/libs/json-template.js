// Copyright (C) 2009 Andy Chu
var log=log||function(){},repr=repr||function(){},jsontemplate=function(){function e(e){return e.replace(/([\{\}\(\)\[\]\|\^\$\-\+\?])/g,"\\$1")}function t(t,n){var r=t+n,a=v[r];if(void 0===a){var o="("+e(t)+".*?"+e(n)+"\n?)";a=new RegExp(o,"g")}return a}function n(e){return e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;")}function r(e){return e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")}function a(e){return null===e?"null":e.toString()}function o(e,t,n){var r,a;switch(n.length){case 0:r="",a="s";break;case 1:r="",a=n[0];break;case 2:r=n[0],a=n[1];break;default:throw{name:"EvaluationError",message:"pluralize got too many args"}}return e>1?a:r}function i(e,t,n){return n[(e-1)%n.length]}function u(e,t){var n=[{context:e,index:-1}];return{PushSection:function(e){if(void 0===e||null===e)return null;var t;return t="@"==e?n[n.length-1].context:n[n.length-1].context[e]||null,n.push({context:t,index:-1}),t},Pop:function(){n.pop()},next:function(){var e=n[n.length-1];-1==e.index&&(e={context:null,index:0},n.push(e));var t=n[n.length-2].context;return e.index==t.length?(n.pop(),void 0):(e.context=t[e.index++],!0)},_Undefined:function(e){if(void 0===t)throw{name:"UndefinedVariable",message:e+" is not defined"};return t},_LookUpStack:function(e){for(var t=n.length-1;;){var r=n[t];if("@index"==e){if(-1!=r.index)return r.index}else{var a=r.context;if("object"==typeof a){var o=a[e];if(void 0!==o)return o}}if(t--,-1>=t)return this._Undefined(e)}},get:function(e){if("@"==e)return n[n.length-1].context;var t=e.split("."),r=this._LookUpStack(t[0]);if(t.length>1)for(var a=1;a<t.length;a++)if(r=r[t[a]],void 0===r)return this._Undefined(t[a]);return r}}}function l(e,t,n){for(var r=0;r<e.length;r++){var a=e[r];if("string"==typeof a)n(a);else{var o=a[0],i=a[1];o(i,t,n)}}}function s(e,t,n){var r;r=t.get(e.name);for(var a=0;a<e.formatters.length;a++){var o=e.formatters[a],i=o[0],u=o[1];r=i(r,t,u)}n(r)}function c(e,t,n){var r=e,a=t.PushSection(r.section_name),o=!1;a&&(o=!0),a&&0===a.length&&(o=!1),o?(l(r.Statements(),t,n),t.Pop()):(t.Pop(),l(r.Statements("or"),t,n))}function f(e,t,n){for(var r=e,a=t.get("@"),o=0;o<r.clauses.length;o++){var i=r.clauses[o],u=i[0][0],s=i[0][1],c=i[1],f=u(a,t,s);if(f){l(c,t,n);break}}}function p(e,t,n){var r=e;if(items=t.PushSection(r.section_name),pushed=!0,items&&items.length>0)for(var a=items.length-1,o=r.Statements(),i=r.Statements("alternate"),u=0;void 0!==t.next();u++)l(o,t,n),u!=a&&l(i,t,n);else l(r.Statements("or"),t,n);t.Pop()}function m(e){return e?"function"==typeof e?new y(e):void 0!==e.lookup?e:"object"==typeof e?new b(e):void 0:new x}function h(e,n){function r(e){var t=d.lookup(e);if(!t[0])throw{name:"BadFormatter",message:e+" is not a valid formatter"};return t}function a(e){var t=v.lookup(e);if(!t[0])throw{name:"BadPredicate",message:e+" is not a valid predicate"};return t}var u,l=m(n.more_formatters),h=k([{name:"pluralize",func:o},{name:"cycle",func:i}]),d=new S([l,b(w),h]),g=m(n.more_predicates),v=new S([g,b(_)]);u=void 0===n.default_formatter?"str":n.default_formatter;var x=n.format_char||"|";if(":"!=x&&"|"!=x)throw{name:"ConfigurationError",message:"Only format characters : and | are accepted"};var y=n.meta||"{}",A=y.length;if(1==A%2)throw{name:"ConfigurationError",message:y+" has an odd number of metacharacters"};for(var R,T=y.substring(0,A/2),j=y.substring(A/2,A),L=t(T,j),z=C({}),F=[z],W=T.length,$=0;;){if(R=L.exec(e),null===R)break;var q=R[0];if(R.index>$){var B=e.slice($,R.index);z.Append(B)}$=L.lastIndex;var G=!1;if("\n"==q.slice(-1)&&(q=q.slice(null,-1),G=!0),q=q.slice(W,-W),"#"!=q.charAt(0)){if("."==q.charAt(0)){q=q.substring(1,q.length);var I={"meta-left":T,"meta-right":j,space:" ",tab:"	",newline:"\n"}[q];if(void 0!==I){z.Append(I);continue}var V,D,H=q.match(U);if(H){var M=H[1],Z=H[3];M?(D=p,V=E({section_name:Z})):(D=c,V=C({section_name:Z})),z.Append([D,V]),F.push(V),z=V;continue}var J,K,Q=q.match(O);if(Q){J=Q[1],K=J?a(J):null,z.NewOrClause(K);continue}var X=!1,Y=q.match(N);if(Y?(J=Y[1],X=!0):"?"==q.charAt(q.length-1)&&(J=q,X=!0),X){K=J?a(J):null,V=P(),V.NewOrClause(K),z.Append([f,V]),F.push(V),z=V;continue}if("alternates with"==q){z.AlternatesWith();continue}if("end"==q){if(F.pop(),!(F.length>0))throw{name:"TemplateSyntaxError",message:"Got too many {end} statements"};z=F[F.length-1];continue}}var et,tt,nt=q.split(x);if(1==nt.length){if(null===u)throw{name:"MissingFormatter",message:"This template requires explicit formatters."};et=[r(u)],tt=q}else{et=[];for(var rt=1;rt<nt.length;rt++)et.push(r(nt[rt]));tt=nt[0]}z.Append([s,{name:tt,formatters:et}]),G&&z.Append("\n")}}if(z.Append(e.slice($)),1!==F.length)throw{name:"TemplateSyntaxError",message:"Got too few {end} statements"};return z}function d(e,t){return this instanceof d?(this._options=t||{},this._program=h(e,this._options),void 0):new d(e,t)}function g(e,t){for(var n={},r=0,a=0;;){var o=!1;if(a=e.indexOf("\n",r),-1==a)break;var i=e.slice(r,a);r=a+1;var u=i.match(R);if(null!==u){var l=u[1].toLowerCase(),s=u[2];l.match(j)&&(l=l.replace("-","_"),s=s.replace(/^\s+/,"").replace(/\s+$/,""),"default_formatter"==l&&"none"==s.toLowerCase()&&(s=null),n[l]=s,o=!0)}if(!o)break}body=n!=={}?e.slice(r):e;for(var c in t)n[c]=t[c];return d(body,n)}var v={},w={html:n,htmltag:r,"html-attr-value":r,str:a,raw:function(e){return e},AbsUrl:function(e,t){return t.get("base-url")+"/"+e}},_={"singular?":function(e){return 1==e},"plural?":function(e){return e>1},"Debug?":function(e,t){try{return t.get("debug")}catch(n){if("UndefinedVariable"==n.name)return!1;throw n}}},x=function(){return{lookup:function(){return[null,null]}}},b=function(e){return{lookup:function(t){var n=e[t]||null;return[n,null]}}},y=function(e){return{lookup:function(t){var n=e(t);return[n,null]}}},k=function(e){return{lookup:function(t){for(var n=0;n<e.length;n++){var r=e[n].name,a=e[n].func;if(t.slice(0,r.length)==r){var o,i=t.charAt(r.length);return o=""===i?[]:t.split(i).slice(1),[a,o]}}return[null,null]}}},S=function(e){return{lookup:function(t){for(var n=0;n<e.length;n++){var r=e[n].lookup(t);if(r[0])return r}return[null,null]}}},A=function(){var e={};return e.current_clause=[],e.Append=function(t){e.current_clause.push(t)},e.AlternatesWith=function(){throw{name:"TemplateSyntaxError",message:"{.alternates with} can only appear with in {.repeated section ...}"}},e.NewOrClause=function(){throw{name:"NotImplemented"}},e},C=function(e){var t=A(e);return t.statements={"default":t.current_clause},t.section_name=e.section_name,t.Statements=function(e){return e=e||"default",t.statements[e]||[]},t.NewOrClause=function(e){if(e)throw{name:"TemplateSyntaxError",message:"{.or} clause only takes a predicate inside predicate blocks"};t.current_clause=[],t.statements.or=t.current_clause},t},E=function(e){var t=C(e);return t.AlternatesWith=function(){t.current_clause=[],t.statements.alternate=t.current_clause},t},P=function(e){var t=A(e);return t.clauses=[],t.NewOrClause=function(e){e=e||[function(){return!0},null],t.current_clause=[],t.clauses.push([e,t.current_clause])},t},U=/(repeated)?\s*(section)\s+(\S+)?/,O=/or(?:\s+(.+))?/,N=/if(?:\s+(.+))?/;d.prototype.render=function(e,t){var n=u(e,this._options.undefined_str);l(this._program.Statements(),n,t)},d.prototype.expand=function(e){var t=[];return this.render(e,function(e){t.push(e)}),t.join("")};var R=/^([a-zA-Z\-]+):\s*(.*)/,T=["meta","format-char","default-formatter","undefined-str"],j=new RegExp(T.join("|"));return{Template:d,HtmlEscape:n,FunctionRegistry:x,SimpleRegistry:b,CallableRegistry:y,ChainedRegistry:S,fromString:g,_Section:C}}();